<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="UnifiedComms">
    <meta name="application-name" content="UnifiedComms">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="description" content="Sensor Watch optical data link - TX/RX unified companion app">
    <title>UNIFIED COMMS</title>
    <style>
        :root {
            --color-bg: #0a0a0a;
            --color-surface: #141414;
            --color-border: #2a2a2a;
            --color-gray: #636764;
            --color-orange: #FB8B24;
            --color-yellow: #F4E409;
            --color-teal: #50D8D7;
            --color-blue: #3B60E4;
            --color-text: #e8e8e8;
            --color-dim: #888;
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 24px;
            --space-4: 32px;
            --radius: 10px;
            --font-mono: 'Courier New', Consolas, Monaco, monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            width: 100%;
            min-height: 100%;
            background: radial-gradient(circle at top right, #1c1c1c 0%, var(--color-bg) 45%);
            color: var(--color-text);
            font-family: var(--font-mono);
            line-height: 1.4;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        body { font-size: 14px; }

        .view { display: none; }
        .view.active { display: block; }

        .screen {
            min-height: 100dvh;
            display: grid;
            grid-template-rows: auto minmax(0, 1fr) auto;
        }

        .top-strip {
            height: 56px;
            display: grid;
            grid-template-columns: 88px 1fr 88px;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
            background: rgba(20, 20, 20, 0.94);
            backdrop-filter: blur(6px);
            padding: 0 var(--space-1);
        }

        .top-strip h1,
        .top-strip h2 {
            text-align: center;
            font-size: 14px;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .top-strip .mode-tx { color: var(--color-orange); }
        .top-strip .mode-rx { color: var(--color-teal); }

        .back-btn {
            min-height: 48px;
            min-width: 48px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            background: #111;
            font-family: var(--font-mono);
            font-size: 13px;
            padding: 0 var(--space-1);
            text-align: left;
            cursor: pointer;
        }

        .spacer { width: 48px; height: 48px; }

        .content-scroll {
            overflow-y: auto;
            padding: var(--space-2);
            padding-bottom: var(--space-3);
        }

        .bottom-bar {
            border-top: 1px solid var(--color-border);
            background: rgba(14, 14, 14, 0.98);
            padding: var(--space-1) var(--space-2) calc(env(safe-area-inset-bottom, 16px) + 8px);
        }

        .frame {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: var(--space-2);
            margin-bottom: var(--space-2);
        }

        .frame-title {
            color: var(--color-dim);
            font-size: 12px;
            letter-spacing: 1px;
            margin-bottom: var(--space-1);
            text-transform: uppercase;
        }

        button {
            min-height: 48px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            background: #161616;
            color: var(--color-text);
            padding: 0 var(--space-2);
        }

        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-1);
        }

        .btn-secondary {
            background: #111;
            color: var(--color-dim);
            border-color: var(--color-border);
        }

        .status-msg {
            padding: var(--space-1);
            margin-bottom: var(--space-2);
            font-size: 13px;
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-blue);
            border-radius: 8px;
            background: #111;
        }
        .status-msg.error { border-left-color: #d44545; color: #ff9d9d; }
        .status-msg.success { border-left-color: var(--color-teal); }

        /* HOME */
        #view-home.active { display: block; }

        .home-screen {
            min-height: 100dvh;
            display: grid;
            grid-template-rows: 1fr auto;
        }

        .home-main {
            padding: var(--space-3) var(--space-2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: var(--space-2);
            max-width: 840px;
            width: 100%;
            margin: 0 auto;
        }

        .home-header {
            text-align: center;
            margin-bottom: var(--space-1);
        }

        .home-title {
            font-size: 34px;
            letter-spacing: 2px;
            color: var(--color-text);
        }

        .home-subtitle {
            font-size: 13px;
            color: var(--color-gray);
            margin-top: var(--space-1);
        }

        .home-watch-art {
            color: var(--color-dim);
            text-align: center;
            font-size: 12px;
            line-height: 1.2;
            padding: var(--space-2);
            border: 1px dashed var(--color-border);
            border-radius: 8px;
            background: #111;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-2);
        }

        .mode-card {
            min-height: 120px;
            border: 2px solid var(--color-border);
            background: linear-gradient(160deg, #141414 0%, #101010 100%);
            border-radius: 12px;
            padding: var(--space-2);
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: var(--space-2);
            cursor: pointer;
        }

        .mode-card:focus { outline: 2px solid var(--color-blue); outline-offset: 2px; }
        .mode-card.tx { border-color: #7d4b1f; }
        .mode-card.rx { border-color: #2f7574; }

        .mode-glyph {
            width: 56px;
            height: 56px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            display: grid;
            place-items: center;
            font-size: 28px;
        }

        .mode-card.tx .mode-glyph { color: var(--color-orange); }
        .mode-card.rx .mode-glyph { color: var(--color-teal); }

        .mode-name {
            font-size: 24px;
            letter-spacing: 1px;
        }

        .mode-desc {
            margin-top: 2px;
            font-size: 13px;
            color: var(--color-gray);
        }

        .home-bottom {
            text-align: center;
            padding: var(--space-1) var(--space-2) calc(env(safe-area-inset-bottom, 16px) + 8px);
            color: var(--color-dim);
            border-top: 1px solid var(--color-border);
            background: rgba(14, 14, 14, 0.96);
            font-size: 12px;
        }

        /* TX */
        #view-tx.active { display: block; }

        #tx-flash-area {
            background: #000;
            margin: var(--space-2);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            display: grid;
            place-items: center;
            text-align: center;
            padding: var(--space-2);
        }

        .tx-flash-icon {
            font-size: 44px;
            color: var(--color-gray);
            line-height: 1;
            margin-bottom: var(--space-1);
        }

        .tx-flash-label {
            font-size: 20px;
            letter-spacing: 2px;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .tx-hint {
            font-size: 12px;
            color: var(--color-dim);
            text-transform: lowercase;
        }

        .tx-actions {
            display: grid;
            gap: var(--space-1);
        }

        #sendTimeBtn {
            width: 100%;
            background: linear-gradient(180deg, #ff9f3f 0%, var(--color-orange) 100%);
            color: #201000;
            border-color: #fca74d;
        }

        #cancelBtn {
            width: 100%;
            display: none;
            background: #8f2f2f;
            border-color: #bf4e4e;
            color: #ffe7e7;
        }

        #tx-status {
            text-align: center;
            font-size: 12px;
            color: var(--color-dim);
            min-height: 18px;
        }

        /* RX */
        #view-rx.active { display: block; }

        textarea {
            width: 100%;
            min-height: 132px;
            resize: vertical;
            border-radius: 8px;
            border: 2px solid #2f7574;
            background: #101010;
            color: var(--color-text);
            padding: var(--space-1);
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.45;
        }

        textarea::placeholder { color: var(--color-gray); }

        .cs-dashboard {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: var(--space-1);
        }

        .cs-metric {
            border: 1px solid var(--color-border);
            background: #101010;
            border-radius: 8px;
            padding: var(--space-1);
            text-align: center;
        }

        .cs-metric.main {
            grid-column: 1 / -1;
            border-color: #6a6328;
            background: linear-gradient(180deg, #171400 0%, #121212 100%);
        }

        .cs-metric .label {
            color: var(--color-gray);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .cs-metric .value {
            font-size: 26px;
            color: var(--color-text);
            line-height: 1.1;
        }

        .cs-metric.main .value {
            font-size: 48px;
            color: var(--color-yellow);
        }

        .chart-container {
            overflow-x: auto;
            padding: var(--space-1);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: #0f0f0f;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .nights-grid {
            display: grid;
            gap: var(--space-1);
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .night-card {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: #101010;
            padding: var(--space-1);
        }

        .night-card.invalid { opacity: 0.5; }

        .night-card .date {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--color-text);
        }

        .night-card .metrics {
            font-size: 12px;
            color: var(--color-gray);
            line-height: 1.35;
        }

        .night-card .quality-bar {
            height: 6px;
            border-radius: 999px;
            background: #1c1c1c;
            margin-top: 6px;
            overflow: hidden;
        }

        .night-card .quality-bar::after {
            content: '';
            display: block;
            width: var(--quality);
            height: 100%;
            background: linear-gradient(90deg, var(--color-teal) 0%, var(--color-yellow) 100%);
        }

        .rx-export-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-1);
        }

        .rx-export-row button {
            background: #121212;
            border-color: #2d458d;
            color: var(--color-blue);
        }

        .shortcuts {
            margin-top: var(--space-2);
            color: var(--color-dim);
            font-size: 11px;
            text-align: center;
        }

        .rx-bottom-actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--space-1);
            margin-bottom: var(--space-1);
        }

        #decodeBtn {
            background: linear-gradient(180deg, #5ce7e6 0%, var(--color-teal) 100%);
            color: #052323;
            border-color: #79edeb;
            width: 100%;
        }

        #clearBtn {
            min-width: 96px;
            background: #111;
            color: var(--color-dim);
        }

        #testBtn {
            width: 100%;
            background: #111;
            color: var(--color-teal);
            border-color: #2f6666;
            font-size: 12px;
        }

        @media (min-width: 760px) {
            body { font-size: 15px; }
            .home-main { padding-top: 56px; }
            .mode-cards { grid-template-columns: 1fr 1fr; }
            .screen,
            .home-screen { max-width: 900px; margin: 0 auto; border-left: 1px solid #1c1c1c; border-right: 1px solid #1c1c1c; }
            .nights-grid { max-height: 360px; }
            .cs-dashboard { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .cs-metric.main { grid-column: span 3; }
        }
    </style>
</head>
<body>

<div id="view-home" class="view">
    <div class="home-screen">
        <div class="home-main">
            <div class="home-header">
                <div class="home-title">UNIFIED COMMS</div>
                <div class="home-subtitle">Sensor Watch optical data link</div>
            </div>

            <pre class="home-watch-art">
 .------.
 |00:00 |
 | WATCH|
 |------|
 | o  o |
 '------'</pre>

            <div class="mode-cards">
                <div class="mode-card tx" id="homeCardTX" onclick="navigate('#tx')" tabindex="0" role="button" aria-label="TX Transmit mode">
                    <div class="mode-glyph">&gt;</div>
                    <div>
                        <div class="mode-name">TRANSMIT</div>
                        <div class="mode-desc">Optical time sync</div>
                    </div>
                </div>

                <div class="mode-card rx" id="homeCardRX" onclick="navigate('#rx')" tabindex="0" role="button" aria-label="RX Receive mode">
                    <div class="mode-glyph">◆</div>
                    <div>
                        <div class="mode-name">RECEIVE</div>
                        <div class="mode-desc">Decode sleep data</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="home-bottom">v1.0</div>
    </div>
</div>

<div id="view-tx" class="view">
    <div class="screen">
        <div class="top-strip">
            <button class="back-btn" onclick="navigate('#home')" aria-label="Back to home">&lt; BACK</button>
            <h2 class="mode-tx">TX MODE</h2>
            <div class="spacer"></div>
        </div>

        <div id="tx-flash-area">
            <div>
                <div class="tx-flash-icon">&gt;</div>
                <div class="tx-flash-label">STANDBY</div>
                <div class="tx-hint">hold screen 2-6in from watch</div>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="tx-actions">
                <button id="sendTimeBtn" onclick="sendTimeSync()">SEND TIME SYNC</button>
                <button id="cancelBtn" onclick="cancelTransmission()">CANCEL</button>
                <div id="tx-status" class="tx-status">Ready to transmit</div>
            </div>
        </div>
    </div>
</div>

<div id="view-rx" class="view">
    <div class="screen">
        <div class="top-strip">
            <button class="back-btn" onclick="navigate('#home')" aria-label="Back to home">&lt; BACK</button>
            <h1 class="mode-rx">RX MODE</h1>
            <div class="spacer"></div>
        </div>

        <div class="content-scroll">
            <div class="frame">
                <div class="frame-title">HEX INPUT</div>
                <textarea id="hexInput" placeholder="Paste 574 hex characters (287 bytes x 7 nights)\nExample: A1B2C3D4..."></textarea>
            </div>

            <div id="rx-status" style="display:none"></div>

            <div id="csDashboard" style="display:none">
                <div class="frame">
                    <div class="frame-title">CIRCADIAN SCORE</div>
                    <div class="cs-dashboard">
                        <div class="cs-metric main">
                            <div class="label">OVERALL CS</div>
                            <div class="value" id="csValue">--</div>
                        </div>
                        <div class="cs-metric">
                            <div class="label">SRI</div>
                            <div class="value" id="sriValue">--</div>
                        </div>
                        <div class="cs-metric">
                            <div class="label">DUR</div>
                            <div class="value" id="durValue">--</div>
                        </div>
                        <div class="cs-metric">
                            <div class="label">EFF</div>
                            <div class="value" id="effValue">--</div>
                        </div>
                        <div class="cs-metric">
                            <div class="label">CMP</div>
                            <div class="value" id="cmpValue">--</div>
                        </div>
                        <div class="cs-metric">
                            <div class="label">LGT</div>
                            <div class="value" id="lgtValue">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chartContainer" style="display:none">
                <div class="frame">
                    <div class="frame-title">7-DAY SLEEP TIMELINE</div>
                    <div class="chart-container">
                        <canvas id="sleepChart" width="640" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div id="nightsContainer" style="display:none">
                <div class="frame">
                    <div class="frame-title">NIGHT DETAILS</div>
                    <div class="nights-grid" id="nightsGrid"></div>
                </div>
            </div>

            <div id="exportSection" style="display:none">
                <div class="frame">
                    <div class="frame-title">EXPORT</div>
                    <div class="rx-export-row">
                        <button onclick="exportCSV()">EXPORT CSV</button>
                        <button onclick="exportJSON()">EXPORT JSON</button>
                    </div>
                    <div style="margin-top:8px;">
                        <button class="btn-secondary" style="width:100%;" onclick="viewHistory()">VIEW HISTORY</button>
                    </div>
                </div>
            </div>

            <div class="shortcuts">[D]ECODE - [C]LEAR - [E]XPORT - ESC=RESET</div>
        </div>

        <div class="bottom-bar">
            <div class="rx-bottom-actions">
                <button id="decodeBtn" onclick="decodeData()">DECODE</button>
                <button id="clearBtn" onclick="clearData()">CLEAR</button>
            </div>
            <button id="testBtn" onclick="loadTestData()">TEST DATA</button>
        </div>
    </div>
</div>

<script>
/* FESKDecoder (inlined from decoder.js) */
class FESKDecoder {
    constructor() {
        this.db = null;
        this.initDB();
    }

    async initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('FESKData', 1);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => { this.db = request.result; resolve(); };
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('sleepData')) {
                    const store = db.createObjectStore('sleepData', { keyPath: 'timestamp' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        });
    }

    hexToBytes(hex) {
        const clean = hex.replace(/[^0-9A-Fa-f]/g, '');
        if (clean.length !== 574) {
            throw new Error(`Invalid hex length: ${clean.length} (expected 574)`);
        }
        const bytes = new Uint8Array(287);
        for (let i = 0; i < 287; i++) {
            bytes[i] = parseInt(clean.substr(i * 2, 2), 16);
        }
        return bytes;
    }

    parseNights(bytes) {
        const nights = [];
        const view = new DataView(bytes.buffer);
        for (let i = 0; i < 7; i++) {
            const off = i * 41;
            const night = {
                onset:      view.getUint32(off,      true),
                offset:     view.getUint32(off + 4,  true),
                duration:   view.getUint16(off + 8,  true),
                efficiency: view.getUint8 (off + 10),
                waso:       view.getUint16(off + 11, true),
                awakenings: view.getUint8 (off + 13),
                light:      view.getUint8 (off + 14),
                valid:      view.getUint8 (off + 15)
            };
            if (night.valid && night.onset > 0) {
                night.onsetTime    = new Date(night.onset  * 1000);
                night.offsetTime   = new Date(night.offset * 1000);
                night.durationHours = (night.duration / 60).toFixed(1);
                night.quality      = this.calculateQuality(night);
            }
            nights.push(night);
        }
        return nights;
    }

    calculateQuality(night) {
        if (!night.valid) return 0;
        const effScore   = night.efficiency;
        const hours      = night.duration / 60;
        const durScore   = (hours >= 7 && hours <= 9) ? 100 :
                           (hours >= 6 && hours <  7) ? 80  :
                           (hours >  9 && hours <= 10)? 80  : 60;
        const awakeScore = Math.max(0, 100 - (night.awakenings * 15));
        const wasoScore  = Math.max(0, 100 - (night.waso / 2));
        return Math.round(effScore * 0.4 + durScore * 0.3 + awakeScore * 0.2 + wasoScore * 0.1);
    }

    calculateCircadianScore(nights) {
        const valid = nights.filter(n => n.valid && n.onset > 0);
        if (valid.length < 3) {
            return { cs: 0, sri: 0, duration: 0, efficiency: 0, compliance: 0, light: 0 };
        }
        const onsetHours = valid.map(n => {
            const d = new Date(n.onset * 1000);
            return d.getHours() + d.getMinutes() / 60;
        });
        const meanOnset  = onsetHours.reduce((a, b) => a + b) / onsetHours.length;
        const variance   = onsetHours.reduce((s, h) => s + Math.pow(h - meanOnset, 2), 0) / onsetHours.length;
        const sri        = Math.max(0, Math.min(100, 100 - variance * 10));
        const avgDur     = valid.reduce((s, n) => s + n.duration, 0) / valid.length / 60;
        const duration   = (avgDur >= 7 && avgDur <= 9) ? 100 :
                           (avgDur >= 6 && avgDur <  7) ? 85  :
                           (avgDur >  9 && avgDur <= 10)? 85  : 60;
        const efficiency = Math.round(valid.reduce((s, n) => s + n.efficiency, 0) / valid.length);
        const compliance = Math.round(valid.length / 7 * 100);
        const light      = Math.round(valid.reduce((s, n) => s + n.light, 0) / valid.length / 2.55);
        const cs         = Math.round(sri * 0.25 + duration * 0.25 + efficiency * 0.25 + compliance * 0.15 + light * 0.10);
        return { cs, sri: Math.round(sri), duration, efficiency, compliance, light };
    }

    async storeData(nights, circadianScore) {
        if (!this.db) await this.initDB();
        const tx    = this.db.transaction(['sleepData'], 'readwrite');
        const store = tx.objectStore('sleepData');
        const record = { timestamp: Date.now(), nights, circadianScore, receivedAt: new Date().toISOString() };
        store.add(record);
        return record;
    }

    async getAllData() {
        if (!this.db) await this.initDB();
        return new Promise((resolve, reject) => {
            const tx      = this.db.transaction(['sleepData'], 'readonly');
            const store   = tx.objectStore('sleepData');
            const request = store.getAll();
            request.onerror   = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    }

    exportCSV(nights, cs) {
        let csv = 'Date,Onset,Offset,Duration(h),Efficiency(%),WASO(min),Awakenings,Light,Quality\n';
        nights.forEach(n => {
            if (n.valid && n.onset > 0) {
                const date   = new Date(n.onset  * 1000).toISOString().split('T')[0];
                const onset  = new Date(n.onset  * 1000).toTimeString().substr(0, 5);
                const offset = new Date(n.offset * 1000).toTimeString().substr(0, 5);
                csv += `${date},${onset},${offset},${n.durationHours},${n.efficiency},${n.waso},${n.awakenings},${n.light},${n.quality}\n`;
            }
        });
        csv += `\nCircadian Score,${cs.cs}\nSRI,${cs.sri}\nDuration,${cs.duration}\nEfficiency,${cs.efficiency}\nCompliance,${cs.compliance}\nLight,${cs.light}\n`;
        return csv;
    }

    exportJSON(nights, cs) {
        return JSON.stringify({ version: '1.0', exportTime: new Date().toISOString(), nights, circadianScore: cs }, null, 2);
    }

    downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
    }
}

/* NAVIGATION */
const VIEWS = ['home', 'tx', 'rx'];

function navigate(hash) {
    const viewKey = (hash || '#home').replace('#', '') || 'home';
    VIEWS.forEach(v => {
        const el = document.getElementById('view-' + v);
        if (el) el.classList.remove('active');
    });
    const target = document.getElementById('view-' + viewKey);
    if (target) {
        target.classList.add('active');
    } else {
        document.getElementById('view-home').classList.add('active');
    }
    const newHash = '#' + (VIEWS.includes(viewKey) ? viewKey : 'home');
    if (location.hash !== newHash) history.pushState(null, '', newHash);
    // Lock scroll for TX (fullscreen flash), unlock for others
    document.body.style.overflow = (viewKey === 'tx') ? 'hidden' : '';
    // If leaving TX, cancel any ongoing transmission
    if (viewKey !== 'tx' && transmitting) cancelTransmission();
}

window.addEventListener('popstate', () => navigate(location.hash || '#home'));

// Keyboard shortcuts on Home
document.getElementById('homeCardTX').addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); navigate('#tx'); }
});
document.getElementById('homeCardRX').addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); navigate('#rx'); }
});

/* TX LOGIC (from optical-tx.html) */
let transmitting = false;
let wakeLock     = null;
let txCountdownTimer = null;

const txFlashArea  = document.getElementById('tx-flash-area');
const txStatusEl   = document.getElementById('tx-status');
const txFlashLabel = txFlashArea.querySelector('.tx-flash-label');
const txFlashIcon  = txFlashArea.querySelector('.tx-flash-icon');

async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    } catch (err) {
        console.log('Wake lock failed:', err);
    }
}

// CRC-8/MAXIM  polynomial 0x31 reversed
function crc8(data) {
    let crc = 0;
    for (const byte of data) {
        crc ^= byte;
        for (let i = 0; i < 8; i++) {
            crc = (crc & 0x01) ? (crc >> 1) ^ 0x8C : crc >> 1;
        }
    }
    return crc;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// Manchester encoding: 0 = HIGH->LOW (white->black), 1 = LOW->HIGH (black->white)
async function flashBit(bit) {
    const h = 50; // 50ms half-bit => 100ms/bit => 10bps
    if (bit === 0) {
        txFlashArea.style.background = '#FFFFFF';
        await sleep(h);
        txFlashArea.style.background = '#000000';
        await sleep(h);
    } else {
        txFlashArea.style.background = '#000000';
        await sleep(h);
        txFlashArea.style.background = '#FFFFFF';
        await sleep(h);
    }
}

async function flashByte(byte) {
    for (let i = 7; i >= 0; i--) {
        if (!transmitting) return;
        await flashBit((byte >> i) & 0x01);
    }
}

async function flashPacket(data) {
    await flashByte(0xAA); // SYNC byte: 10101010
    for (const byte of data) {
        if (!transmitting) return;
        await flashByte(byte);
    }
    txFlashArea.style.background = '#000000';
}

async function sendTimeSync() {
    if (transmitting) return;
    transmitting = true;

    document.getElementById('sendTimeBtn').style.display = 'none';
    document.getElementById('cancelBtn').style.display   = 'block';
    txFlashLabel.textContent = 'TRANSMITTING...';
    txFlashIcon.textContent  = '>';

    await requestWakeLock();

    const now            = Math.floor(Date.now() / 1000);
    const tzOffset       = -new Date().getTimezoneOffset(); // minutes from UTC

    // Packet: LEN(0x06) + TYPE(0x01) + timestamp(4 LE) + timezone(2 LE) + CRC
    const packet = [
        0x06,
        0x01,
        (now >>  0) & 0xFF,
        (now >>  8) & 0xFF,
        (now >> 16) & 0xFF,
        (now >> 24) & 0xFF,
        (tzOffset >> 0) & 0xFF,
        (tzOffset >> 8) & 0xFF,
    ];
    packet.push(crc8(packet));

    const totalBytes       = packet.length + 1; // +1 for SYNC
    const estimatedSeconds = Math.ceil(totalBytes * 0.8);
    let remainingSeconds = estimatedSeconds;
    txStatusEl.textContent = `Transmitting ${totalBytes} bytes (${remainingSeconds}s remaining)`;
    if (txCountdownTimer) clearInterval(txCountdownTimer);
    txCountdownTimer = setInterval(() => {
        if (!transmitting) return;
        remainingSeconds = Math.max(0, remainingSeconds - 1);
        txStatusEl.textContent = `Transmitting ${totalBytes} bytes (${remainingSeconds}s remaining)`;
    }, 1000);

    try {
        await flashPacket(packet);
        if (transmitting) {
            txFlashArea.style.background = 'var(--color-bg)';
            txFlashLabel.textContent = 'DONE';
            txFlashIcon.textContent  = '◆';
            txStatusEl.textContent   = 'Transmission complete';
            await sleep(2000);
            txStatusEl.textContent   = 'Ready to transmit';
            txFlashLabel.textContent = 'STANDBY';
            txFlashIcon.textContent  = '>';
        }
    } catch (err) {
        txStatusEl.textContent = 'Error: ' + err.message;
    } finally {
        transmitting = false;
        if (txCountdownTimer) { clearInterval(txCountdownTimer); txCountdownTimer = null; }
        document.getElementById('sendTimeBtn').style.display = 'block';
        document.getElementById('cancelBtn').style.display   = 'none';
        txFlashArea.style.background = 'var(--color-bg)';
        if (wakeLock) { await wakeLock.release(); wakeLock = null; }
    }
}

function cancelTransmission() {
    if (!transmitting && document.getElementById('cancelBtn').style.display === 'none') return;
    transmitting = false;
    txFlashArea.style.background  = 'var(--color-bg)';
    txFlashLabel.textContent      = 'STANDBY';
    txFlashIcon.textContent       = '>';
    txStatusEl.textContent        = 'Cancelled';
    if (txCountdownTimer) { clearInterval(txCountdownTimer); txCountdownTimer = null; }
    document.getElementById('sendTimeBtn').style.display = 'block';
    document.getElementById('cancelBtn').style.display   = 'none';
    setTimeout(() => { txStatusEl.textContent = 'Ready to transmit'; }, 2000);
    if (wakeLock) { wakeLock.release(); wakeLock = null; }
}

document.addEventListener('visibilitychange', () => {
    if (!document.hidden && transmitting) requestWakeLock();
});

/* RX LOGIC (from fesk-decoder.html) */
const decoder = new FESKDecoder();
let currentNights = null;
let currentCS     = null;

async function decodeData() {
    const hex = document.getElementById('hexInput').value;
    try {
        showRxStatus('Decoding binary data...', 'success');
        const bytes  = decoder.hexToBytes(hex);
        const nights = decoder.parseNights(bytes);
        const cs     = decoder.calculateCircadianScore(nights);
        currentNights = nights;
        currentCS     = cs;
        await decoder.storeData(nights, cs);
        renderDashboard(cs);
        renderChart(nights);
        renderNights(nights);
        const validCount = nights.filter(n => n.valid).length;
        showRxStatus(`[OK] Decoded ${validCount}/7 valid nights`, 'success');
        document.getElementById('csDashboard').style.display    = 'block';
        document.getElementById('chartContainer').style.display  = 'block';
        document.getElementById('nightsContainer').style.display = 'block';
        document.getElementById('exportSection').style.display   = 'block';
    } catch (err) {
        showRxStatus(`[ERR] ${err.message}`, 'error');
        console.error(err);
    }
}

function renderDashboard(cs) {
    document.getElementById('csValue').textContent  = cs.cs;
    document.getElementById('sriValue').textContent = cs.sri;
    document.getElementById('durValue').textContent = cs.duration;
    document.getElementById('effValue').textContent = cs.efficiency;
    document.getElementById('cmpValue').textContent = cs.compliance;
    document.getElementById('lgtValue').textContent = cs.light;
}

function renderChart(nights) {
    const canvas = document.getElementById('sleepChart');
    const ctx    = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    ctx.fillStyle = '#111111';
    ctx.fillRect(0, 0, W, H);

    const maxH = H - 40;

    // Grid lines every 2 hours
    ctx.strokeStyle = '#2a2a2a';
    ctx.lineWidth   = 1;
    for (let hr = 2; hr <= 10; hr += 2) {
        const y = H - (hr / 10 * maxH) - 20;
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
        ctx.fillStyle  = '#888888';
        ctx.font       = '10px monospace';
        ctx.textAlign  = 'right';
        ctx.fillText(`${hr}h`, W - 4, y - 2);
    }

    const barW = Math.floor(W / 7) - 8;

    nights.forEach((night, i) => {
        if (!night.valid || night.onset === 0) return;
        const x       = i * (barW + 8) + 4;
        const barH    = (night.duration / 600) * maxH; // 600 min = 10h = full height
        const y       = H - barH - 20;
        const q       = night.quality;
        const color   = q >= 80 ? '#F4E409' : q >= 60 ? '#50D8D7' : q >= 40 ? '#3B60E4' : '#636764';

        ctx.fillStyle   = color;
        ctx.fillRect(x, y, barW, barH);
        ctx.strokeStyle = '#2a2a2a';
        ctx.lineWidth   = 1;
        ctx.strokeRect(x, y, barW, barH);

        ctx.fillStyle = '#e8e8e8';
        ctx.font      = '10px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(`${night.durationHours}h`, x + barW / 2, y - 4);

        const d      = new Date(night.onset * 1000);
        const day    = ['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()];
        ctx.fillText(day, x + barW / 2, H - 4);
    });
}

function renderNights(nights) {
    const grid = document.getElementById('nightsGrid');
    grid.innerHTML = '';
    nights.forEach((night, i) => {
        const card = document.createElement('div');
        card.className = 'night-card' + (night.valid ? '' : ' invalid');
        if (night.valid && night.onset > 0) {
            const date     = new Date(night.onset  * 1000);
            const dateStr  = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const onsetT   = date.toTimeString().substr(0, 5);
            const offsetT  = new Date(night.offset * 1000).toTimeString().substr(0, 5);
            card.innerHTML = `
                <div class="date">Night ${i + 1}: ${dateStr}</div>
                <div class="metrics">
                    ${onsetT} -&gt; ${offsetT} - ${night.durationHours}h<br>
                    EFF: ${night.efficiency}% - WASO: ${night.waso}m - AWK: ${night.awakenings}<br>
                    LIGHT: ${night.light} - QUAL: ${night.quality}
                </div>
                <div class="quality-bar" style="--quality: ${night.quality}%"></div>`;
        } else {
            card.innerHTML = `
                <div class="date">Night ${i + 1}: NO DATA</div>
                <div class="metrics">Invalid or missing</div>`;
        }
        grid.appendChild(card);
    });
}

function exportCSV() {
    if (!currentNights || !currentCS) return;
    const csv  = decoder.exportCSV(currentNights, currentCS);
    const name = `fesk_export_${new Date().toISOString().split('T')[0]}.csv`;
    decoder.downloadFile(csv, name, 'text/csv');
    showRxStatus('[OK] CSV exported', 'success');
}

function exportJSON() {
    if (!currentNights || !currentCS) return;
    const json = decoder.exportJSON(currentNights, currentCS);
    const name = `fesk_export_${new Date().toISOString().split('T')[0]}.json`;
    decoder.downloadFile(json, name, 'application/json');
    showRxStatus('[OK] JSON exported', 'success');
}

async function viewHistory() {
    const history = await decoder.getAllData();
    const latest  = history.length > 0 ? new Date(history[history.length - 1].timestamp).toLocaleString() : 'none';
    alert(`${history.length} record(s) in IndexedDB\n\nMost recent: ${latest}`);
}

function clearData() {
    document.getElementById('hexInput').value = '';
    currentNights = null;
    currentCS     = null;
    document.getElementById('csDashboard').style.display    = 'none';
    document.getElementById('chartContainer').style.display  = 'none';
    document.getElementById('nightsContainer').style.display = 'none';
    document.getElementById('exportSection').style.display   = 'none';
    document.getElementById('rx-status').style.display       = 'none';
}

function loadTestData() {
    document.getElementById('hexInput').value = generateTestHex();
    showRxStatus('[OK] Test data loaded (7 sample nights)', 'success');
}

function generateTestHex() {
    const now    = Math.floor(Date.now() / 1000);
    const nights = [];
    for (let i = 6; i >= 0; i--) {
        const dayAgo   = now - i * 86400;
        const onset    = dayAgo - (dayAgo % 86400) + 23 * 3600;
        const duration = 420 + Math.floor(Math.random() * 60);
        const offset   = onset + duration * 60;
        const eff      = 85  + Math.floor(Math.random() * 10);
        const waso     = 10  + Math.floor(Math.random() * 20);
        const awk      = Math.floor(Math.random() * 3);
        const light    = 100 + Math.floor(Math.random() * 100);
        const bytes    = new Uint8Array(41);
        const view     = new DataView(bytes.buffer);
        view.setUint32(0,  onset,    true);
        view.setUint32(4,  offset,   true);
        view.setUint16(8,  duration, true);
        view.setUint8 (10, eff);
        view.setUint16(11, waso,     true);
        view.setUint8 (13, awk);
        view.setUint8 (14, light);
        view.setUint8 (15, 1); // valid flag
        nights.push(bytes);
    }
    const all = new Uint8Array(287);
    nights.forEach((n, i) => all.set(n, i * 41));
    return Array.from(all).map(b => b.toString(16).padStart(2, '0')).join('');
}

function showRxStatus(message, type = 'success') {
    const el  = document.getElementById('rx-status');
    el.className     = `status-msg ${type}`;
    el.textContent   = message;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// Keyboard shortcuts (active only in RX view)
document.addEventListener('keydown', e => {
    if (!document.getElementById('view-rx').classList.contains('active')) return;
    if (e.key === 'd' || e.key === 'D') { e.preventDefault(); decodeData(); }
    else if (e.key === 'c' || e.key === 'C') { e.preventDefault(); clearData(); }
    else if (e.key === 'e' || e.key === 'E') { e.preventDefault(); if (currentNights) exportCSV(); }
    else if (e.key === 'Escape') clearData();
});

/* INIT */
navigate(location.hash || '#home');
console.log('UNIFIED COMMS v1.0 - Sensor Watch FESK');
console.log('TX: Manchester optical @ 10bps | RX: 7-night circadian decoder');
</script>
</body>
</html>
