name: Custom Firmware Build
run-name: "custom-build[${{ github.event.inputs.build_id }}] ${{ github.event.inputs.board }}/${{ github.event.inputs.display }}"

on:
  workflow_dispatch:
    inputs:
      faces:
        description: "Comma-separated face IDs (e.g. clock_face,alarm_face,movement_settings_face)"
        required: true
        type: string
      board:
        description: "Board type"
        required: true
        type: choice
        options:
          - sensorwatch_red
          - sensorwatch_green
          - sensorwatch_blue
          - sensorwatch_pro
      display:
        description: "Display type"
        required: true
        type: choice
        options:
          - classic
          - custom
      secondary_index:
        description: "MOVEMENT_SECONDARY_FACE_INDEX (numeric)"
        required: false
        default: "0"
        type: string
      clock_24h:
        description: "Default 24h mode"
        required: false
        default: false
        type: boolean
      led_red:
        description: "Default LED red intensity (0-15)"
        required: false
        default: "0"
        type: string
      led_green:
        description: "Default LED green intensity (0-15)"
        required: false
        default: "15"
        type: string
      led_blue:
        description: "Default LED blue intensity (0-15)"
        required: false
        default: "0"
        type: string
      button_sound:
        description: "Enable button click sound by default"
        required: false
        default: true
        type: boolean
      signal_tune:
        description: "Signal tune define (e.g. SIGNAL_TUNE_DEFAULT)"
        required: false
        default: "SIGNAL_TUNE_DEFAULT"
        type: string
      active_hours_enabled:
        description: 'Active hours enabled (first boot default)'
        type: boolean
        default: true
      active_hours_start:
        description: 'Active hours start, quarter-hours 0-95 (0=00:00, 16=04:00)'
        type: string
        default: '16'
      active_hours_end:
        description: 'Active hours end, quarter-hours 0-95 (92=23:00, 95=23:45)'
        type: string
        default: '92'
      build_id:
        description: "Unique build ID from the web UI"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/armmbed/mbed-os-env:latest
    env:
      BOARD: ${{ github.event.inputs.board }}
      DISPLAY: ${{ github.event.inputs.display }}
      BUILD_ID: ${{ github.event.inputs.build_id }}

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Generate movement_config.h
        env:
          INPUT_FACES: ${{ github.event.inputs.faces }}
          INPUT_SECONDARY_INDEX: ${{ github.event.inputs.secondary_index }}
          INPUT_CLOCK_24H: ${{ github.event.inputs.clock_24h }}
          INPUT_LED_RED: ${{ github.event.inputs.led_red }}
          INPUT_LED_GREEN: ${{ github.event.inputs.led_green }}
          INPUT_LED_BLUE: ${{ github.event.inputs.led_blue }}
          INPUT_BUTTON_SOUND: ${{ github.event.inputs.button_sound }}
          INPUT_SIGNAL_TUNE: ${{ github.event.inputs.signal_tune }}
          INPUT_ACTIVE_HOURS_ENABLED: ${{ inputs.active_hours_enabled }}
          INPUT_ACTIVE_HOURS_START: ${{ inputs.active_hours_start }}
          INPUT_ACTIVE_HOURS_END: ${{ inputs.active_hours_end }}
        run: |
          python3 .github/scripts/generate_config.py \
            --faces "$INPUT_FACES" \
            --secondary-index "$INPUT_SECONDARY_INDEX" \
            --clock-24h "$INPUT_CLOCK_24H" \
            --led-red "$INPUT_LED_RED" \
            --led-green "$INPUT_LED_GREEN" \
            --led-blue "$INPUT_LED_BLUE" \
            --button-sound "$INPUT_BUTTON_SOUND" \
            --signal-tune "$INPUT_SIGNAL_TUNE" \
            --active-hours-enabled "$INPUT_ACTIVE_HOURS_ENABLED" \
            --active-hours-start "$INPUT_ACTIVE_HOURS_START" \
            --active-hours-end "$INPUT_ACTIVE_HOURS_END" \
            --output movement_config.h

      - name: Generate watch-faces.mk
        env:
          INPUT_FACES: ${{ github.event.inputs.faces }}
        run: |
          python3 .github/scripts/generate_watchfaces_mk.py \
            --faces "$INPUT_FACES" \
            --registry builder/face_registry.json \
            --output watch-faces.mk

      - name: Compile firmware
        run: make

      - name: Rename UF2 artifact
        run: |
          cp build/firmware.uf2 \
            "${BOARD}-${DISPLAY}-${BUILD_ID}.uf2"

      - name: Upload to GitHub Release
        id: upload_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: custom-builds
          name: "Custom Builds"
          draft: false
          prerelease: true
          files: |
            ${{ env.BOARD }}-${{ env.DISPLAY }}-${{ env.BUILD_ID }}.uf2

      - name: Output build summary
        run: |
          ASSET_NAME="${BOARD}-${DISPLAY}-${BUILD_ID}.uf2"
          REPO="${{ github.repository }}"
          DOWNLOAD_URL="https://github.com/${REPO}/releases/download/custom-builds/${ASSET_NAME}"
          echo "Build complete." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Build ID: ${BUILD_ID}" >> "$GITHUB_STEP_SUMMARY"
          echo "Board: ${BOARD}" >> "$GITHUB_STEP_SUMMARY"
          echo "Display: ${DISPLAY}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Download: ${DOWNLOAD_URL}" >> "$GITHUB_STEP_SUMMARY"
