name: Cleanup Old Custom Builds

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:
    inputs:
      max_age_days:
        description: "Delete assets older than this many days (default: 7)"
        required: false
        default: "7"
        type: string

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Delete release assets older than 7 days
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '7' }}
        run: |
          set -euo pipefail

          TAG="custom-builds"
          REPO="${{ github.repository }}"
          NOW=$(date +%s)
          MAX_AGE_SECONDS=$(( MAX_AGE_DAYS * 86400 ))
          DELETED=0
          KEPT=0

          # Fetch asset list from the release; exit cleanly if the release does not exist yet.
          if ! ASSETS_JSON=$(gh release view "$TAG" --json assets --repo "$REPO" 2>/dev/null); then
            echo "Release '$TAG' does not exist yet. Nothing to clean up."
            exit 0
          fi

          ASSET_COUNT=$(echo "$ASSETS_JSON" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          print(len(data.get('assets', [])))
          ")

          if [ "$ASSET_COUNT" -eq 0 ]; then
            echo "No assets found in release '$TAG'."
            exit 0
          fi

          echo "Found $ASSET_COUNT asset(s) in release '$TAG'. Checking age..."

          # Extract asset names and creation timestamps, then delete stale ones.
          echo "$ASSETS_JSON" | python3 -c "
          import json, sys, datetime

          data = json.load(sys.stdin)
          now = $NOW
          max_age = $MAX_AGE_SECONDS
          for asset in data.get('assets', []):
              name = asset['name']
              created_at = asset['createdAt']
              # createdAt format: 2024-01-15T12:34:56Z
              dt = datetime.datetime.strptime(created_at, '%Y-%m-%dT%H:%M:%SZ')
              ts = int(dt.timestamp())
              age = now - ts
              if age > max_age:
                  print('DELETE', name)
              else:
                  print('KEEP', name)
          " | while read -r ACTION ASSET_NAME; do
            if [ "$ACTION" = "DELETE" ]; then
              echo "Deleting: $ASSET_NAME"
              gh release delete-asset "$TAG" "$ASSET_NAME" --yes --repo "$REPO" || \
                echo "WARNING: Failed to delete $ASSET_NAME (may already be gone)."
              DELETED=$(( DELETED + 1 ))
            else
              echo "Keeping:  $ASSET_NAME"
              KEPT=$(( KEPT + 1 ))
            fi
          done

          echo "Cleanup complete."
